<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>=PLAY=CAVE=</title>
    <meta name="keywords" content="zombies, maze">
    <meta name="description" content="free game">
    <meta name="author" content="Carolina Garrido, Diogo Marques">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

    <style>
        body {
            background-color: #000000;
            text-align: center;
        }
    </style>
</head>

<body>
    <script type="module">
        var config = {
            type: Phaser.CANVAS,
            width: 800,
            height: 670,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);

        var map;
        var tileset;
        var layer;
        var tilesize = 32;

        var player;
        //player é uma array
        //0 - o objeto em si
        //1 - a velocidade máxima do jogador
        const basePlayerSpeed = 160;
        const basePlayerDecceleration = 550;
        var playerSpawn;
        var cursors;

        var zombies;
        const baseZombieSpeed = 40;
        var zombieSpeed = baseZombieSpeed;
        var landmines;
        var coins;
        var exits;
        var helps;

        var cameraMain;
        var cameraHud;
        const maxHearts = 5;
        var hearts = maxHearts;
        var coinsRemaining;
        var coinsCollected = 0;

        var gameOver = false;
        var text;
        var rect;

        var sfxCoin;
        var sfxHitLight;
        var sfxHitHeavy;

        function preload() {
            this.load.image('tiles', 'assets/textures32.png');
            this.load.tilemapTiledJSON('untitled', 'assets/untitled.json');
            this.load.image('twink', 'assets/twink.png')
            this.load.image('orb', 'assets/orb.png')
            this.load.spritesheet('coin', 'assets/coin.png', { frameWidth: 16 })
            this.load.image('bomb', 'assets/bomb.png');
            this.load.spritesheet('human', 'assets/spritesheets/2 walk.png', { frameWidth: 16, frameHeight: 16 })
            this.load.spritesheet('dead-player', 'assets/spritesheets/3 idle.png', { frameWidth: 16, frameHeight: 16 })
            this.load.spritesheet('zombie', 'assets/spritesheets/4 walk.png', { frameWidth: 16, frameHeight: 16 })
            this.load.audio('getCoin', 'assets/sounds/grab_coin.mp3');
            this.load.audio('hitLight', 'assets/sounds/hit_light.mp3');
            this.load.audio('hitHeavy', 'assets/sounds/hit_heavy.mp3');
        }

        function create() {
            map = this.make.tilemap({ key: 'untitled' })
            tileset = map.addTilesetImage('tiles', 'tiles');
            layer = map.createLayer('layer', tileset);

            map.setCollisionByProperty({ collides: true });

            sfxCoin = this.sound.add('getCoin');
            sfxHitLight = this.sound.add('hitLight');
            sfxHitHeavy = this.sound.add('hitHeavy');

            //vai buscar o spawn do ficheiro do mapa
            playerSpawn = this.physics.add.existing(
                map.createFromObjects('playerSpawn', {
                    key: 'orb',
                    classType: Phaser.Physics.Arcade.Sprite
                })
                [0]);
            //ao criar o jogador, criamos uma array
            //1º elemento é a sprite
            //2º elemento é a velocidade desta criatura
            player = [this.physics.add.sprite(playerSpawn.x, playerSpawn.y, 'human'), basePlayerSpeed];
            player[0].setOrigin(0.5)
            player[0].body.setAllowDrag(true).setDrag(basePlayerDecceleration).setFriction(0)
            this.physics.add.collider(player, layer)
            this.physics.add.overlap(player, playerSpawn, reachSpawn);
            playerSpawn.disableBody(true, true);

            this.anims.create({
                key: 'idle',
                frames: [
                    { key: 'human', frame: 0 }
                ],
                frameRate: 1,
                repeat: -1
            });
            this.anims.create({
                key: 'walk-down',
                frames: [
                    { key: 'human', frame: 0 },
                    { key: 'human', frame: 3 },
                    { key: 'human', frame: 6 },
                    { key: 'human', frame: 9 }
                ],
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'walk-up',
                frames: [
                    { key: 'human', frame: 1 },
                    { key: 'human', frame: 4 },
                    { key: 'human', frame: 7 },
                    { key: 'human', frame: 10 }
                ],
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'walk-right',
                frames: [
                    { key: 'human', frame: 2 },
                    { key: 'human', frame: 5 },
                    { key: 'human', frame: 8 },
                    { key: 'human', frame: 11 }
                ],
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'player-zombie',
                frames: [
                    { key: 'dead-player', frame: 0 },
                    { key: 'dead-player', frame: 3 }
                ],
                frameRate: 4,
                repeat: -1
            });

            cursors = this.input.keyboard.createCursorKeys();


            this.anims.create({
                key: 'spin',
                frames: this.anims.generateFrameNumbers('coin'),
                frameRate: 10,
                repeat: -1
            });
            coins = this.physics.add.group(
                map.createFromObjects('coins', {
                    key: 'coin',
                    classType: Phaser.Physics.Arcade.Sprite
                }));

            coins.children.iterate(coin => {
                coin.play('spin')
            })


            landmines = this.physics.add.group(
                map.createFromObjects('landmines', {
                    key: 'bomb',
                    classType: Phaser.Physics.Arcade.Sprite
                }));
            this.physics.add.collider(player, landmines, hitLandmine);


            this.physics.add.overlap(player, coins, collectCoin);

            zombies = this.physics.add.group(
                map.createFromObjects('zombieSpawns', {
                    key: 'zombie',
                    classType: Phaser.Physics.Arcade.Sprite
                }));

            this.physics.add.overlap(player, zombies, hitZombie);
            this.physics.add.collider(zombies, layer, redirectZombie)

            this.anims.create({
                key: 'z-walk-down',
                frames: [
                    { key: 'zombie', frame: 0 },
                    { key: 'zombie', frame: 3 },
                    { key: 'zombie', frame: 6 },
                    { key: 'zombie', frame: 9 }
                ],
                frameRate: 4,
                repeat: -1
            });
            this.anims.create({
                key: 'z-walk-up',
                frames: [
                    { key: 'zombie', frame: 1 },
                    { key: 'zombie', frame: 4 },
                    { key: 'zombie', frame: 7 },
                    { key: 'zombie', frame: 10 }
                ],
                frameRate: 4,
                repeat: -1
            });
            this.anims.create({
                key: 'z-walk-right',
                frames: [
                    { key: 'zombie', frame: 2 },
                    { key: 'zombie', frame: 5 },
                    { key: 'zombie', frame: 8 },
                    { key: 'zombie', frame: 11 }
                ],
                frameRate: 4,
                repeat: -1
            });

            zombies.children.iterate(zombie => {
                zombie.setOrigin(0.5, 0.5)
                redirectZombie(zombie)
            })


            cameraMain = this.cameras.main
            cameraMain.setSize(800, 600);
            cameraMain.setPosition(0, 70);
            cameraMain.setBounds(0, 0, layer.width, layer.height);
            cameraMain.startFollow(player[0], false, 1, 1);
            cameraMain.roundPixels = true;
            //cameraMain.setZoom(0.5,0.5)

            //    this.minimap = this.cameras.add(100, 100, 200, 200).setZoom(0.1).setName('mini');
            //    this.minimap.setBackgroundColor(0x000000);
            //    this.minimap.scrollX = 1600;
            //    this.minimap.scrollY = 300;

            cameraHud = this.cameras.add(0, 0, 800, 70).setScroll(0, -70).setName('hud');
            text = this.add.text(4, -66, 'lorem ipsum', { font: '34px Courier', fill: '#fa0' });
            rect = this.add.rectangle(0, -500, 800, 100, 0xbb0000).setScrollFactor(0).setDepth(10)

        }

        function update(time, delta) {
            if (!gameOver) {

                movePlayer()

                coinsRemaining = coins.countActive(true)
                if (coinsRemaining > 0) {
                    text.setText([
                        'vidas: ' + hearts,
                        'moedas restantes: ' + coins.countActive(true)
                    ]);
                } else {
                    text.setText([
                        'vidas: ' + hearts,
                        'Apanhaste todas! Volta ao centro!'
                    ]);
                }

                //mais uma vida
                this.input.keyboard.on('keyup-A', function (event) {
                    hearts++
                    this.input.keyboard.stopListeners();
                });
                //reset velocidade do jogador
                this.input.keyboard.on('keyup-S', function (event) {
                    player[1] = basePlayerSpeed;
                    this.input.keyboard.stopListeners();
                });
                //aumentar velocidade dos zombies
                this.input.keyboard.on('keyup-D', function (event) {
                    zombieSpeed += 5
                    this.input.keyboard.stopListeners();
                });
                //apanhar todas as moedas
                this.input.keyboard.on('keyup-F', function (event) {
                    coins.children.iterate(function (child) {
                        child.disableBody(true, true);
                        playerSpawn.enableBody(false, playerSpawn.x, playerSpawn.y, true, true)
                    });
                    this.input.keyboard.stopListeners();
                });

            } else {
                rect.setPosition(400, 300)
                text.setScrollFactor(0).setAlign('center').setPosition(400, 300).setColor('#fff').setDepth(20).setOrigin(0.5)
                text.setText([
                    'GAME OVER',
                    'Apanhaste ' + coinsCollected + ' moedas',
                    '\'F5\' para começar de novo'
                ]);
            }
        }

        //mover a personagem numa direção
        function movePlayer() {
            var speedX = 0, speedY = 0
            var speed = player[1];
            if (cursors.up.isDown) speedY -= speed;
            if (cursors.down.isDown) speedY += speed;
            if (cursors.left.isDown) speedX -= speed;
            if (cursors.right.isDown) speedX += speed;

            if (speedY < 0) {
                player[0].play('walk-up', true);
            } else if (speedY > 0) {
                player[0].play('walk-down', true);
            } else if (speedX < 0) {
                player[0].flipX = true;
                player[0].play('walk-right', true);
            } else if (speedX > 0) {
                player[0].flipX = false;
                player[0].play('walk-right', true);
            } else {
                player[0].play('idle', true);
            }

            if (speedX != 0 && speedY != 0) {
                speedX = speedX * 0.8;
                speedY = speedY * 0.8;
                player[0].setVelocity(speedX, speedY);
            } else if (speedX != 0) {
                player[0].setVelocityX(speedX);
            } else if (speedY != 0) {
                player[0].setVelocityY(speedY);
            }
        }

        function redirectZombie(zombie, layer) {
            zombie.x = Math.floor((zombie.x) / tilesize) * tilesize + tilesize / 2;
            zombie.y = Math.floor((zombie.y) / tilesize) * tilesize + tilesize / 2;

            var options = [];
            if (map.getTileAtWorldXY(zombie.x - tilesize, zombie.y).collides == false)
                options.push(Phaser.LEFT);

            if (map.getTileAtWorldXY(zombie.x, zombie.y - tilesize).collides == false)
                options.push(Phaser.UP);

            if (map.getTileAtWorldXY(zombie.x + tilesize, zombie.y).collides == false)
                options.push(Phaser.RIGHT);

            if (map.getTileAtWorldXY(zombie.x, zombie.y + tilesize).collides == false)
                options.push(Phaser.DOWN);

            moveZombie(
                zombie,
                options[Math.floor(Math.random() * options.length)],
                zombieSpeed)

        }
        function moveZombie(zombie, direction, speed) {

            if (direction == Phaser.LEFT) {
                zombie.setVelocity(-speed, 0)
                zombie.flipX = true;
                zombie.play('z-walk-right', true);
            }
            else if (direction == Phaser.UP) {
                zombie.setVelocity(0, -speed)
                zombie.play('z-walk-up', true);
            }
            else if (direction == Phaser.RIGHT) {
                zombie.setVelocity(+speed, 0)
                zombie.flipX = false;
                zombie.play('z-walk-right', true);
            }
            else if (direction == Phaser.DOWN) {
                zombie.setVelocity(0, +speed)
                zombie.play('z-walk-down', true);
            }
        }

        function collectCoin(player, coin) {
            sfxCoin.play()

            coin.disableBody(true, true);
            if (coins.countActive(true) === 0) {
                playerSpawn.enableBody(false, playerSpawn.x, playerSpawn.y, true, true)
            }
            coinsCollected++
        }

        function hitLandmine(player, landmine) {
            sfxHitLight.play();

            landmine.disableBody(true, true);
            cameraMain.shake(200, 0.008);
            takeDamage();
        }

        function hitZombie(human, zombie) {
            sfxHitHeavy.play();

            zombie.disableBody(true, true);
            cameraMain.shake(300, 0.012);
            takeDamage();
            player[1] -= 5;
        }

        function takeDamage() {
            hearts--;
            if (hearts == -1) {
                gameOver = true;
                player[0].disableBody(true,false)
                player[0].play('player-zombie', true)
                sfxHitHeavy.play();
            }
        }

        function reachSpawn(player, playerSpawn) {
            player[1] = basePlayerSpeed;
            hearts++;
            zombieSpeed += 5
            if (coins.countActive(true) === 0) {
                coins.children.iterate(function (child) {

                    child.enableBody(false, child.x, child.y, true, true);

                });
                playerSpawn.disableBody(true, true);
            }
        }


    </script>

</body>

</html>