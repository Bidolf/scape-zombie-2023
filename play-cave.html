<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>=PLAY=CAVE=</title>
    <meta name="keywords" content="zombies, maze">
    <meta name="description" content="free game">
    <meta name="author" content="Carolina Garrido, Diogo Marques">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

    <style>
        body {
            background-color: #000000;
            text-align: center;
        }
    </style>
</head>

<body>
    <script type="module">
        var config = {
            type: Phaser.CANVAS,
            width: 800,
            height: 670,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);

        var map;
        var tileset;
        var layer;
        var tilesize = 32;

        var player;
        //player é uma array
        //0 - o objeto em si
        //1 - a velocidade máxima do jogador
        var playerSpawn;
        var cursors;

        var zombies;
        var landmines;
        var coins;
        var exits;
        var helps;

        var cameraMain;
        var cameraHud;
        const maxHearts = 5;
        var hearts = maxHearts;
        var coinsRemaining;
        var coinsCollected = 0;

        var gameOver = false;
        var text;
        var rect;

        function preload() {
            this.load.image('tiles', 'assets/textures32.png');
            this.load.tilemapTiledJSON('untitled', 'assets/untitled.json');
            this.load.image('twink', 'assets/twink.png')
            this.load.image('orb', 'assets/orb.png')
            this.load.spritesheet('coin', 'assets/coin.png', { frameWidth: 16 })
            this.load.image('bomb', 'assets/bomb.png');
            this.load.spritesheet('human', 'assets/charsprites/char1.png',{ frameWidth: 16, frameHeight: 16 })
            this.load.spritesheet('zombie', 'assets/charsprites/4 walk.png',{ frameWidth: 16, frameHeight: 16 })
        }

        function create() {
            map = this.make.tilemap({ key: 'untitled' })
            tileset = map.addTilesetImage('tiles', 'tiles');
            layer = map.createLayer('layer', tileset);

            map.setCollisionByProperty({ collides: true });


            //vai buscar o spawn do ficheiro do mapa
            playerSpawn = this.physics.add.existing(
                map.createFromObjects('playerSpawn', {
                    key: 'orb',
                    classType: Phaser.Physics.Arcade.Sprite
                })
                [0]);
            //ao criar o jogador, criamos uma array
            //1º elemento é a sprite
            //2º elemento é a velocidade desta criatura
            player = [this.physics.add.sprite(playerSpawn.x, playerSpawn.y, 'human'), 160];
            player[0].setOrigin(0.5)
            player[0].body.setAllowDrag(true).setDrag(550).setFriction(0)
            this.physics.add.collider(player, layer)
            this.physics.add.overlap(player, playerSpawn, reachSpawn);
            playerSpawn.disableBody(true, true);

            this.anims.create({
                key: 'idle',
                frames: [
                    { key: 'human', frame: 0 },
                    { key: 'human', frame: 3 }
                ],
                frameRate: 1,
                repeat: -1
            });
            this.anims.create({
                key: 'walk-down',
                frames: [
                    { key: 'human', frame: 6 },
                    { key: 'human', frame: 9 },
                    { key: 'human', frame: 12 },
                    { key: 'human', frame: 15 }
                ],
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'walk-up',
                frames: [
                    { key: 'human', frame: 7 },
                    { key: 'human', frame: 10 },
                    { key: 'human', frame: 13 },
                    { key: 'human', frame: 16 }
                ],
                frameRate: 8,
                repeat: -1
            });
            this.anims.create({
                key: 'walk-right',
                frames: [
                    { key: 'human', frame: 8 },
                    { key: 'human', frame: 11 },
                    { key: 'human', frame: 14 },
                    { key: 'human', frame: 17 }
                ],
                frameRate: 8,
                repeat: -1
            });

            cursors = this.input.keyboard.createCursorKeys();


            this.anims.create({
                key: 'spin',
                frames: this.anims.generateFrameNumbers('coin'),
                frameRate: 10,
                repeat: -1
            });

            coins = this.physics.add.group(
                map.createFromObjects('coins', {
                    key: 'coin',
                    classType: Phaser.Physics.Arcade.Sprite
                }));

            coins.children.iterate(coin => {
                coin.play('spin')
            })

            this.physics.add.overlap(player, coins, collectCoin);

            zombies = this.physics.add.group(
                map.createFromObjects('zombieSpawns', {
                    key: 'zombie',
                    classType: Phaser.Physics.Arcade.Sprite
                }));
            
            this.physics.add.overlap(player, zombies, hitZombie);
            this.anims.create({
                key: 'walk-right',
                frames: [
                    { key: 'zombie', frame: 2 },
                    { key: 'zombie', frame: 5 },
                    { key: 'zombie', frame: 8 },
                    { key: 'zombie', frame: 11 }
                ],
                frameRate: 6,
                repeat: -1
            });


            landmines = this.physics.add.group(
                map.createFromObjects('landmines', {
                    key: 'bomb',
                    classType: Phaser.Physics.Arcade.Sprite
                }));
            this.physics.add.collider(player, landmines, hitLandmine);

            cameraMain = this.cameras.main
            cameraMain.setSize(800, 600);
            cameraMain.setPosition(0, 70);
            cameraMain.setBounds(0, 0, layer.width, layer.height);
            cameraMain.startFollow(player[0], false, 1, 1);
            cameraMain.roundPixels = true;

            //    this.minimap = this.cameras.add(100, 100, 200, 200).setZoom(0.1).setName('mini');
            //    this.minimap.setBackgroundColor(0x000000);
            //    this.minimap.scrollX = 1600;
            //    this.minimap.scrollY = 300;

            cameraHud = this.cameras.add(0, 0, 800, 70).setScroll(0, -70).setName('hud');
            text = this.add.text(4, -66, 'lorem ipsum', { font: '34px Courier', fill: '#fa0' });
            rect = this.add.rectangle(0, -300, 800, 100, 0xbb0000).setScrollFactor(0).setDepth(10)

        }

        function update(time, delta) {
            if (!gameOver) {

                movePlayer()

                moveZombies()

                coinsRemaining = coins.countActive(true)
                if (coinsRemaining > 0) {
                    text.setText([
                        'vidas: ' + hearts,
                        'moedas restantes: ' + coins.countActive(true)
                    ]);
                } else {
                    text.setText([
                        'vidas: ' + hearts,
                        'Apanhaste todas! Volta ao centro!'
                    ]);
                }
            } else {
                rect.setPosition(400,300)
                text.setScrollFactor(0).setAlign('center').setPosition(400, 300).setColor('#fff').setDepth(20).setOrigin(0.5)
                text.setText([
                    'GAME OVER',
                    'Apanhaste ' + coinsCollected + ' moedas',
                    '\'F5\' para começar de novo'
                ]);
            }
        }

        /*
        function snapToGrid(body){
            if(body.velocity.x == 0){
                body.center.x = Phaser.Math.RoundTo(body.center.x / tilesize, 0) * tilesize;
            }
            if(body.velocity.y == 0){
                body.center.y = Phaser.Math.RoundTo(body.center.y / tilesize, 0) * tilesize;
            }
        }
        */


        //ver se a personagem pode andar para o tile que está nesta direção (à esquerda, etc.)
        function checkDirection(entity, direction) {
            var relativeX = entity.body.x;
            var relativeY = entity.body.y;

            if (direction == Phaser.LEFT) relativeX -= tilesize;
            if (direction == Phaser.RIGHT) relativeX += tilesize;
            if (direction == Phaser.UP) relativeY -= tilesize;
            if (direction == Phaser.DOWN) relativeY += tilesize;

            if (getTileAtWorldXY(relativeX, relativeY).properties[0]) {

            }
        }

        //mover a personagem numa direção
        function movePlayer() {
            var speedX = 0, speedY = 0
            var speed = player[1];
            if (cursors.up.isDown) speedY -= speed;
            if (cursors.down.isDown) speedY += speed;
            if (cursors.left.isDown) speedX -= speed;
            if (cursors.right.isDown) speedX += speed;

            if(speedY < 0){
                player[0].play('walk-up',true);
            }else if(speedY > 0){
                player[0].play('walk-down',true);
            }else  if(speedX < 0){
                player[0].flipX = true;
                player[0].play('walk-right',true);
            }else  if(speedX > 0){
                player[0].flipX = false;
                player[0].play('walk-right',true);
            }else{
                player[0].play('idle',true);
            }

            if (speedX != 0 && speedY != 0) {
                speedX = speedX * 0.8;
                speedY = speedY * 0.8;
                player[0].setVelocity(speedX, speedY);
            } else if (speedX != 0) {
                player[0].setVelocityX(speedX);
            } else if (speedY != 0) {
                player[0].setVelocityY(speedY);
            }
        }

        function moveZombies(){
            zombies.children.iterate(zombie => {

            })
        }

        function collectCoin(player, coin) {
            coin.disableBody(true, true);
            if (coins.countActive(true) === 0) {
                playerSpawn.enableBody(false, playerSpawn.x, playerSpawn.y, true, true)
            }
            coinsCollected++
        }

        function hitLandmine(player, landmine) {
            landmine.disableBody(true, true);
            cameraMain.shake(100, 0.008);
            takeDamage();
        }

        function hitZombie(human, zombie) {
            zombie.disableBody(true, true);
            cameraMain.shake(150, 0.012);
            takeDamage();
            player[1] -= 10;
        }

        function takeDamage() {
            hearts--;
            if (hearts == 0) {
                gameOver = true;
            }
        }

        function reachSpawn(player, playerSpawn) {
            if (coins.countActive(true) === 0) {
                coins.children.iterate(function (child) {

                    child.enableBody(false, child.x, child.y, true, true);

                });
                playerSpawn.disableBody(true, true);
            }
        }


    </script>

</body>

</html>